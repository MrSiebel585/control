.env.backup_restore

# .env.backup_restore
# Purpose: Environment configuration for Omniscient backup, restore, and migration
# Location: /opt/omniscient/.env.backup_restore
# Usage: Source this in backup/restore/merge scripts

##### 🔐 Backup Defaults #####
OMNIBACKUP_DIR="/opt/omniscient/backups"
OMNIBACKUP_LOG="/opt/omniscient/logs/backup_restore.log"
OMNIBACKUP_MANIFEST_DIR="/opt/omniscient/manifests"
OMNIBACKUP_TAG_PREFIX="omniscient_backup"
OMNIBACKUP_INCLUDE_HASH="true"
OMNIBACKUP_INCLUDE_ENV_VARS="true"
OMNIBACKUP_AUTO_ZIP="false"
OMNIBACKUP_USE_GIT_TAGS="false"

##### 🔁 Restore Settings #####
OMNIRESTORE_TMP="/tmp/omniscient_restore"
OMNIRESTORE_FORCE_OVERWRITE="false"
OMNIRESTORE_DRY_RUN="false"
OMNIRESTORE_VERIFY_HASH="true"

##### 🔄 Merge Settings #####
OMNIMERGE_LOG="/opt/omniscient/logs/merge_migration.log"
OMNIMERGE_MODE="interactive"        # Options: interactive, auto, dry
OMNIMERGE_CONFLICT_POLICY="prompt"  # Options: prompt, newer, source, skip
OMNIMERGE_METADATA_TAGGING="true"

##### 🌐 Git Restore Settings #####
OMNIGIT_RESTORE_REPO=""
OMNIGIT_RESTORE_BRANCH="main"
OMNIGIT_RESTORE_TO="/opt/omniscient"

##### 🧠 Manifest Output #####
OMNIMANIFEST_BACKUP_FILE="$OMNIBACKUP_MANIFEST_DIR/manifest.backup.csv"
OMNIMANIFEST_RESTORE_FILE="$OMNIBACKUP_MANIFEST_DIR/manifest.restore.csv"

##### 📎 Metadata Tracking #####
OMNIMETA_FILESTAMP_TAG="created_by=omniscientctl"
OMNIMETA_USER="$(whoami)"
OMNIMETA_DATE="$(date +%F)"
OMNIMETA_HOST="$(hostname)"



source /opt/omniscient/.env.backup_restore

BACKUP_PATH="$OMNIBACKUP_DIR/${OMNIBACKUP_TAG_PREFIX}_$OMNIMETA_DATE"
mkdir -p "$BACKUP_PATH"

rsync -a "$OMNI_HOME/" "$BACKUP_PATH/" \
  --exclude='__pycache__' \
  --exclude='*.log'

if [[ "$OMNIBACKUP_INCLUDE_HASH" == "true" ]]; then
  find "$BACKUP_PATH" -type f | xargs md5sum > "$BACKUP_PATH/manifest.md5"
fi

echo "[✓] Backup complete at $BACKUP_PATH" | tee -a "$OMNIBACKUP_LOG"



source /opt/omniscient/.env.backup_restore

if [[ "$OMNIRESTORE_DRY_RUN" == "true" ]]; then
  echo "[DRY RUN] Would restore from $RESTORE_SRC"
  tree "$RESTORE_SRC"
else
  cp -r "$RESTORE_SRC"/* "$OMNI_HOME/"
  [[ "$OMNIRESTORE_VERIFY_HASH" == "true" ]] && md5sum -c "$RESTORE_SRC/manifest.md5"
fi
